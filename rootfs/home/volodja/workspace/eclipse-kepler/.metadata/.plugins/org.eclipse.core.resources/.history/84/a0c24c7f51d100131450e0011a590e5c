/*
 * async_tcp_service.cpp
 *
 *  Created on: 30 апр. 2014 г.
 *      Author: volodja
 */





#include "async_tcp_service.h"


namespace config {
namespace implementation {


AsyncTCPService::AsyncTCPService(io_service &service_id)
:
    service_id  (service_id),
    socket      (service_id)
{}


AsyncTCPService::~AsyncTCPService() {
}


void AsyncTCPService::start() {
}


void AsyncTCPService::stop() {
}


void AsyncTCPService::stepHandler(const error_code &error, const size_t &buffer_size) {
    auto stepHandler    = bind(&AsyncTCPService::stepHandler, this, _1, _2);
    auto parseResponse  = bind(&AsyncTCPService::parseResponse, this);

    reenter(this) {
        while (true) {
            yield async_read_until  (socket, read_buffer, string("\n"), stepHandler);
            yield service_id.post(parseResponse);
            yield async_write       (socket, write_buffer, stepHandler);
        };
    };
}


void AsyncTCPService::parseResponse() {
    BOOST_LOG_TRIVIAL(trace) << "response: " << &read_buffer;
}


} /* namespace implementation */
} /* namespace config */
